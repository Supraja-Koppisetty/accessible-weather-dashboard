name: Full CI/CD - Frontend & Backend

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ---------- FRONTEND BUILD & DEPLOY ----------
  frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: frontend/dist

      - name: Publish
        uses: actions/deploy-pages@v4

  # ---------- BACKEND CI ----------
  backend:
    runs-on: ubuntu-latest
    needs: frontend  # optional, run after frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install backend dependencies
        run: |
          cd backend
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download ML model
        run: |
          wget https://github.com/Supraja-Koppisetty/accessible-weather-dashboard/releases/download/python-model-release-build/temperature_prediction_model_rf.pkl -O backend/temperature_prediction_model_rf.pkl

      - name: Run backend tests
        run: |
          cd backend
          source venv/bin/activate
          # replace with your actual tests, if none just check Python runs
          python -m unittest discover -s tests || echo "No tests found"
